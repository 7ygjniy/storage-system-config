<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>储能系统方案配置工具</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Global Resets & Base Styles --- */
        :root {
            --primary-color: #FF7900; /* 阳光橙 */
            --primary-color-dark: #E06C00; /* 阳光橙 - 深色 */
            --primary-color-extralight: #fff5eb; /* 阳光橙 - 极浅色 (用于Mermaid子图背景) */
            --text-color-base: #606060; /* 中灰 - 主要文本 */
            --text-color-headings: #333333; /* 深灰 - 标题 */
            --text-color-light: #FFFFFF; /* 白色文本 */
            
            --bg-color-light: #FFFFFF; /* 页面和浅色区块背景 */
            --bg-color-medium: #f4f6f8; /* 更浅的灰，用于区块背景 */
            --bg-color-card: #FFFFFF; /* 卡片背景 */
            --border-color-soft: #e0e0e0; /* 柔和边框色 */
            --border-color-medium: #cccccc; 

            --bg-color-dark: #2B686F;  /* 深蓝灰 - 页脚等 */
            --tech-blue-primary: #007AFF; /* 科技蓝 - 参考Apple */
            --tech-blue-light-bg: #f0f7ff; /* 科技蓝 - 轻背景 */


            --accent-color-yellow: #EEB83F; /* 辅助色 - 淡黄 */
            --accent-color-teal: #55BAB4;   /* 辅助色 - 蓝绿 */

            --font-family-base: 'Noto Sans SC', 'Helvetica Neue', Arial, sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.7;

            --border-radius: 8px;
            --container-width: 1200px;
            --header-height: 75px; 
            --header-height-scrolled: 65px;
            --transition-speed: 0.3s;
            --animation-duration: 0.6s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            font-size: var(--font-size-base);
        }

        body {
            font-family: var(--font-family-base);
            line-height: var(--line-height-base);
            color: var(--text-color-base);
            background-color: var(--bg-color-light);
            overflow-x: hidden;
        }

        /* --- Typography --- */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 0.75em;
            color: var(--text-color-headings);
        }
        .hero-title { 
            color: var(--text-color-light); 
            font-size: clamp(2.2rem, 5vw, 3.5rem); 
            margin-bottom: 0.4em; 
            text-shadow: 1px 1px 4px rgba(0,0,0,0.4); 
            font-weight: 700;
        }
        .hero-subtitle { 
            color: rgba(255,255,255,0.9); 
            font-size: clamp(1rem, 2vw, 1.3rem); 
            margin-bottom: 1.8em; 
            font-weight: 400; 
            max-width: 750px; 
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }
        .section-title { 
            font-size: clamp(1.8rem, 4vw, 2.8rem); 
            text-align: center; 
            margin-bottom: 1em; 
            position: relative; 
        }
        .section-title::after {
            content: '';
            display: block;
            width: 70px;
            height: 4px;
            background-color: var(--primary-color);
            margin: 0.4em auto 0;
            border-radius: 2px;
        }
        .section-intro { 
            text-align: center; 
            font-size: 1.1rem; 
            color: var(--text-color-base); 
            margin-bottom: 3em; 
            max-width: 750px; 
            margin-left: auto; 
            margin-right: auto;
            font-weight: 300;
        }

        p { margin-bottom: 1.2em; }
        a { color: var(--primary-color); text-decoration: none; transition: color var(--transition-speed) ease; }
        a:hover { color: var(--primary-color-dark); }

        /* --- Layout & Container --- */
        .section-container, .header-container, .footer-container {
            width: 90%;
            max-width: var(--container-width);
            margin: 0 auto;
            padding: 0 20px;
        }
        .content-section { 
            padding: clamp(60px, 10vh, 100px) 0;
        }
         .content-section:nth-child(even) { 
            background-color: var(--bg-color-medium); 
        }
        #project-inputs-section { /* Ensure project inputs always has light background */
             background-color: var(--bg-color-light);
        }


        /* --- Header / Navigation --- */
        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            height: var(--header-height);
            background-color: transparent;
            box-shadow: none;
            transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, height var(--transition-speed) ease;
        }
        .main-header.scrolled {
            background-color: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            height: var(--header-height-scrolled);
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }
        .logo-link img.logo {
            height: 120px !important; /* Increased size to 120px */
            width: 120px !important;  /* Increased size to 120px */
            object-fit: contain !important; /* 改为contain，保持比例不变形 */
            background-color: transparent; /* 尝试透明背景 */
            border-radius: 8px; /* 添加圆角 */
            padding: 8px; /* 添加内边距 */
            transition: height var(--transition-speed) ease, width var(--transition-speed) ease;
        }
        .main-header.scrolled .logo-link img.logo {
            height: 110px !important; /* Increased size to 110px */
            width: 110px !important; /* Increased size to 110px */
            object-fit: contain !important; /* 保持contain */
            padding: 6px; /* 减少内边距 */
        }

        .main-nav ul {
            list-style: none;
            display: flex;
            gap: clamp(20px, 3.5vw, 40px); 
        }
        .main-nav a {
            color: var(--text-color-headings); 
            font-weight: 500;
            font-size: clamp(0.9rem, 1.5vw, 1rem);
            padding: 10px 0;
            position: relative;
        }
        .main-header:not(.scrolled) .main-nav a { 
             color: var(--text-color-light); 
        }
        .main-header.scrolled .main-nav a {
            color: var(--text-color-headings);
        }

        .main-nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary-color);
            transition: width var(--transition-speed) ease;
        }
        .main-nav a:hover::after, .main-nav a.active::after {
            width: 100%;
        }

        .menu-toggle { display: none; background: none; border: none; cursor: pointer; padding: 10px; z-index: 1001;}
        .menu-icon-bar { display: block; width: 25px; height: 3px; margin: 5px 0; transition: transform 0.3s ease, opacity 0.3s ease; border-radius: 1px;}
        .main-header:not(.scrolled) .menu-icon-bar { background-color: var(--text-color-light); }
        .main-header.scrolled .menu-icon-bar { background-color: var(--text-color-headings); }


        /* --- Hero Section --- */
        .hero-section {
            min-height: 90vh; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: linear-gradient(rgba(0, 0, 0, 0.45), rgba(0, 0, 0, 0.65)), url('https://images.unsplash.com/photo-1585070680114-3d8e9a429f6d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1920&q=80') no-repeat center center/cover; /* New placeholder image for better contrast with orange */
            color: var(--text-color-light);
            padding-top: var(--header-height); 
            position: relative; 
        }
        .hero-content {
            max-width: 800px;
            padding: 20px;
        }

        /* --- Buttons --- */
        .btn {
            display: inline-block;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 500;
            border: 2px solid transparent;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            text-transform: uppercase;
            letter-spacing: 0.8px; 
        }
        .btn:disabled { 
            background-color: #cccccc;
            border-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--text-color-light);
            border-color: var(--primary-color);
        }
        .btn-primary:not(:disabled):hover {
            background-color: var(--primary-color-dark);
            border-color: var(--primary-color-dark);
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .btn-primary:not(:disabled):active {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-hero {
            padding: 15px 40px;
            font-size: 1.1rem;
            margin-top: 1em;
        }
        

        /* --- Input Forms --- */
        .input-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            align-items: end;
            background-color: var(--bg-color-card); /* Changed to card background */
            padding: clamp(25px, 5vw, 45px); 
            border-radius: var(--border-radius);
            box-shadow: 0 8px 30px rgba(0,0,0,0.07);
        }
        
        /* 在大屏幕上优化布局 */
        @media (min-width: 1200px) {
            .input-form-grid {
                grid-template-columns: 1fr 1fr 1.5fr; /* 3列布局 */
                grid-template-rows: auto auto; /* 明确设置两行，自动高度 */
                grid-template-areas: 
                    "power capacity device-sets"
                    "system-select button device-sets"; /* 让设备套数限制跨越两行 */
                align-items: start; /* 重置为start对齐 */
            }
            .input-group:nth-child(1) { grid-area: power; }
            .input-group:nth-child(2) { grid-area: capacity; }
            .device-sets-group { 
                grid-area: device-sets; 
                align-self: stretch; /* 让设备套数限制容器填满整个区域 */
                display: flex;
                flex-direction: column;
                justify-content: space-between; /* 内容分布在顶部和底部 */
            }
            .system-selection-group { grid-area: system-select; }
            .button-group { grid-area: button; }
        }
        
        @media (min-width: 992px) and (max-width: 1199px) {
            .input-form-grid {
                grid-template-columns: 1fr 1fr 1.3fr; /* 稍微紧凑的3列布局 */
                grid-template-rows: auto auto; /* 明确设置两行，自动高度 */
                grid-template-areas: 
                    "power capacity device-sets"
                    "system-select button device-sets"; /* 让设备套数限制跨越两行 */
                align-items: start; /* 重置为start对齐 */
            }
            .input-group:nth-child(1) { grid-area: power; }
            .input-group:nth-child(2) { grid-area: capacity; }
            .device-sets-group { 
                grid-area: device-sets; 
                align-self: stretch; /* 让设备套数限制容器填满整个区域 */
                display: flex;
                flex-direction: column;
                justify-content: space-between; /* 内容分布在顶部和底部 */
            }
            .system-selection-group { grid-area: system-select; }
            .button-group { grid-area: button; }
        }
        
        @media (min-width: 768px) and (max-width: 991px) {
            .input-form-grid {
                grid-template-columns: 1fr 1fr; /* 2列布局 */
                grid-template-areas: 
                    "power capacity"
                    "device-sets device-sets"
                    "system-select button";
            }
            .input-group:nth-child(1) { grid-area: power; }
            .input-group:nth-child(2) { grid-area: capacity; }
            .device-sets-group { grid-area: device-sets; }
            .system-selection-group { grid-area: system-select; }
            .button-group { grid-area: button; }
        }
        
        .input-group { 
            display: flex; 
            flex-direction: column; 
        }
        .input-group label {
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-color-base);
            font-size: 0.95rem;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 18px; 
            border: 1px solid var(--border-color-medium); /* Use defined border color */
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            background-color: var(--bg-color-light); /* Lighter background for inputs */
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 121, 0, 0.15);
        }
        .button-group .btn { width: 100%; padding: 14px 18px;}

        /* --- 最大设备套数相关样式 --- */
        .device-sets-container {
            position: relative;
            border: 1px solid var(--border-color-soft);
            border-radius: var(--border-radius);
            padding: 20px;
            background-color: var(--bg-color-light);
            transition: opacity var(--transition-speed) ease;
            height: 100%; /* 让容器填满父元素高度 */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* 内容从顶部开始 */
        }
        .device-sets-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-shrink: 0; /* 不允许收缩 */
        }
        .device-sets-title {
            font-weight: 500;
            color: var(--text-color-headings);
            font-size: 0.95rem;
            margin: 0;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        .device-sets-input-area {
            transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease;
            flex-grow: 1; /* 让输入区域占据可用空间 */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .device-sets-input-area.disabled {
            opacity: 0.5;
            pointer-events: none;
            transform: translateY(-5px);
        }
        .min-sets-hint {
            font-size: 0.85rem;
            color: var(--accent-color-teal);
            margin-top: auto; /* 将提示推到底部 */
            padding: 8px 12px;
            background-color: var(--tech-blue-light-bg);
            border-radius: 4px;
            border-left: 3px solid var(--accent-color-teal);
            display: none;
            flex-shrink: 0; /* 不允许收缩 */
        }
        .min-sets-hint.show {
            display: block;
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Results Area & Cards --- */
        .results-summary-section { background-color: var(--bg-color-medium); } /* Use medium bg for this section */
        #solution-message {
            padding: 18px 25px;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            font-size: 1.05em;
            text-align: center;
            border-width: 1px;
            border-style: solid;
        }
        .message-info { background-color: #e8f4fd; border-color: #d1e9fc; color: #0c5460; }
        .message-success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .message-warning { background-color: #fff3cd; border-color: #ffeeba; color: #856404; }
        .message-error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }

        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
        }
        /*
        @media (min-width: 1200px) { /* On larger screens, explicitly set 5, 6 or 7 columns * /
            .metrics-container:has(#total-cost-card[style*="display: block"]) {
                 grid-template-columns: repeat(6, 1fr);
            }
             .metrics-container:not(:has(#total-cost-card[style*="display: block"])) {
                 grid-template-columns: repeat(5, 1fr);
            }
        }
         @media (min-width: 992px) and (max-width: 1199px) {
             .metrics-container { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        }
        */


        .metric-card { 
            background-color: var(--bg-color-card); 
            border: 1px solid var(--border-color-soft);
            padding: 20px; /* Adjusted padding */
            border-radius: var(--border-radius); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            text-align: left;
            display: flex; /* For better internal alignment */
            flex-direction: column;
            justify-content: space-between; /* Distribute space */
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        }
        .metric-card h4 { 
            margin-top: 0; 
            color: var(--text-color-headings); 
            font-size: 1rem; /* Adjusted font size */
            margin-bottom: 8px;
            font-weight: 500;
        }
        .metric-card p { 
            font-size: 1.8em; /* Adjusted font size */
            font-weight: 700; 
            color: var(--primary-color); 
            margin-bottom: 3px; 
            line-height: 1.2; /* Adjust line height for large text */
        }
        .metric-card span { 
            font-size: 0.85em; /* Adjusted font size */
            color: var(--text-color-base); 
        }

        /* Configuration Details & ESS Blocks Styling */
        #configuration-details { background-color: var(--bg-color-medium); }

        .component-section h3 { /* General h3 for AC/DC side */
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 0.8em;
            border-bottom: 2px solid var(--accent-color-yellow);
            padding-bottom: 0.4em;
        }
        .component-list { list-style: none; }
        .component-list li { 
            background-color: #fdfdfd; 
            padding: 12px 15px; 
            border-radius: 4px; 
            margin-bottom: 10px; 
            border: 1px solid var(--border-color-soft); 
            font-size: 0.95rem;
        }
        
        #ess-blocks-section-title { /* Specific title for ESS Blocks if needed, otherwise use .section-title */
            /* Styles for the "储能单元块构成" title itself if different from generic .section-title */
        }

        .ess-blocks-wrapper { /* New wrapper for the card-like layout based on image_828653.png */
            background-color: var(--bg-color-card);
            border: 1px solid var(--border-color-soft);
            border-radius: var(--border-radius);
            padding: clamp(20px, 3vw, 30px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: clamp(20px, 3vw, 30px);
            align-items: stretch; /* Make items same height */
        }

        #ess-blocks-diagrams-container { /* Container for Mermaid diagram */
            flex: 1 1 55%; /* Takes more space, can shrink/grow */
            min-width: 300px; /* Minimum width before wrapping */
            /* background-color: var(--primary-color-extralight); REMOVED to blend with wrapper */
            border-radius: var(--border-radius); /* Keep border-radius if wrapper has one, or remove if it should look seamless */
            padding: 20px; /* Keep padding for spacing around the diagram, adjust if needed */
            display: flex;
            align-items: center;
            justify-content: center;
            /* border: 1px solid var(--primary-color); REMOVED */
        }
        #ess-blocks-diagrams.mermaid svg { /* Ensure SVG is responsive */
            max-width: 100%;
            height: auto;
            display: block; /* Remove extra space below SVG */
            margin: 0 auto; /* Center if smaller than container */
        }
        #ess-blocks-details-text-container { /* Container for text details */
            flex: 1 1 40%; /* Takes less space, can shrink/grow */
            min-width: 280px;
            padding-left: 15px; /* Add some space from diagram */
            border-left: 1px solid var(--border-color-soft); /* Separator line if needed, or remove */
        }
         #ess-blocks-details-text-container p strong {
            color: var(--text-color-headings);
            font-weight: 500;
            display: block;
            margin-bottom: 0.5em;
            font-size: 1.1rem;
        }
        #ess-blocks-details-text-container ul {
            list-style: none; /* Remove default list style */
            padding-left: 0;
        }
        #ess-blocks-details-text-container ul li {
            background-color: var(--bg-color-light);
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color-soft);
            font-size: 0.95rem;
            color: var(--text-color-base);
            transition: background-color 0.2s ease;
        }
         #ess-blocks-details-text-container ul li:hover {
            background-color: var(--tech-blue-light-bg);
        }


        .parameters-list p { font-size: 1.05rem; }
        .parameters-list strong { color: var(--text-color-headings); }
        

        /* --- Footer --- */
        .main-footer {
            background-color: var(--bg-color-dark);
            color: rgba(255,255,255,0.7);
            padding: 40px 0; 
            text-align: center;
        }
        .footer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; 
        }
        .main-footer p { margin-bottom: 0.5em; font-size: 0.9rem;}
        .main-footer .author-info a { color: var(--accent-color-yellow); }
        .main-footer .author-info a:hover { color: var(--text-color-light); }


        /* --- Animation Classes (Scroll-triggered) --- */
        .animate-on-scroll {
            opacity: 0;
            transform: translateY(30px); 
            transition: opacity var(--animation-duration) ease-out, transform var(--animation-duration) ease-out;
        }
        .animate-on-scroll.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .animate-on-scroll.is-visible .metric-card,
        .animate-on-scroll.is-visible .component-section,
        .animate-on-scroll.is-visible .ess-blocks-wrapper > div { /* Animate children of wrapper */
            opacity: 0;
            transform: translateY(20px);
            animation: item-fade-in-up 0.5s ease-out forwards;
        }
        /* Stagger children of ess-blocks-wrapper if needed */
        .ess-blocks-wrapper.is-visible #ess-blocks-diagrams-container { animation-delay: 0.1s; }
        .ess-blocks-wrapper.is-visible #ess-blocks-details-text-container { animation-delay: 0.25s; }


        .metrics-container.is-visible .metric-card:nth-child(1) { animation-delay: 0.1s; }
        .metrics-container.is-visible .metric-card:nth-child(2) { animation-delay: 0.2s; }
        .metrics-container.is-visible .metric-card:nth-child(3) { animation-delay: 0.3s; }
        .metrics-container.is-visible .metric-card:nth-child(4) { animation-delay: 0.4s; }
        .metrics-container.is-visible .metric-card:nth-child(5) { animation-delay: 0.5s; }
        .metrics-container.is-visible .metric-card:nth-child(6) { animation-delay: 0.6s; }
        .metrics-container.is-visible .metric-card:nth-child(7) { animation-delay: 0.7s; }


        @keyframes item-fade-in-up {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        /* --- Responsive Design --- */
        @media (max-width: 992px) {
            .hero-title { font-size: 2.5rem; } 
            .hero-subtitle { font-size: 1.2rem; } 
            .section-title { font-size: 2rem; }
            .metrics-container { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } /* Allow more flexible fitting on tablets */
            .ess-blocks-wrapper { flex-direction: column; } /* Stack diagram and text on tablets */
            #ess-blocks-details-text-container { padding-left: 0; border-left: none; margin-top: 20px; }

        }

        @media (max-width: 768px) {
            .main-nav {
                display: none; 
                position: absolute;
                top: var(--header-height-scrolled); 
                left: 0;
                width: 100%;
                background-color: var(--bg-color-light);
                flex-direction: column;
                padding: 15px 0; 
                box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            }
            .main-header.scrolled .main-nav {
                 top: var(--header-height-scrolled);
            }
            .main-header:not(.scrolled) .main-nav { 
                top: var(--header-height);
                 background-color: rgba(255, 255, 255, 0.98); 
            }

            .main-nav.is-active { display: flex; } 
            .main-nav ul { flex-direction: column; align-items: center; gap: 0;}
            .main-nav li { width: 100%; text-align: center;}
            .main-nav a { 
                padding: 12px 20px; 
                display: block; 
                width: 100%;
                color: var(--text-color-headings); 
            }
            .main-nav a::after { display: none; } 
            .main-nav a:hover { background-color: var(--bg-color-medium); }

            .menu-toggle { display: block; }
            .menu-toggle.is-active .menu-icon-bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
            .menu-toggle.is-active .menu-icon-bar:nth-child(2) { opacity: 0; }
            .menu-toggle.is-active .menu-icon-bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }


            .hero-title { font-size: 2rem; } 
            .hero-subtitle { font-size: 1rem; } 
            .btn-hero { padding: 12px 30px; font-size: 1rem;}
            .input-form-grid { grid-template-columns: 1fr; } 
            .metrics-container { grid-template-columns: 1fr; } 
            .details-grid { grid-template-columns: 1fr; }
        }

        /* --- Print Styles --- */
        @media print {
            body {
                margin: 0;
                font-size: 10pt;
                color: #000;
                background-color: #fff !important; /* Ensure white background for printing */
            }

            .main-header, 
            .main-footer, 
            #project-inputs-section, 
            .menu-toggle, 
            #calculate-button, 
            .btn-hero /* Hide elements not relevant for print */ {
                display: none !important;
            }

            /* Ensure results area and its children are visible if they were part of the report */
            #results-area, 
            #results-area section, 
            #results-area .section-container, 
            #results-area .metrics-container, 
            #results-area .metric-card,
            #results-area #ac-side-container,
            #results-area #dc-side-container,
            #results-area #ess-blocks-container,
            #results-area #solution-parameters,
            #results-area .animate-on-scroll /* Ensure all report parts are displayed */ {
                display: block !important; /* Override any script-based hiding */
                opacity: 1 !important;
                transform: none !important;
                background-color: #fff !important; /* Ensure consistent white background for sections */
            }
            .content-section:nth-child(even) { /* Override alternating background for print */
                 background-color: #fff !important; 
            }

            .section-container, .content-section {
                padding-top: 10px !important;
                padding-bottom: 10px !important;
                box-shadow: none !important;
                border: none !important;
            }
            .section-title {
                font-size: 1.5rem !important;
                margin-bottom: 0.8em !important;
            }
            .section-title::after {
                display: none !important; /* Hide decorative underline from section titles */
            }

            .metric-card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                padding: 10px !important;
                page-break-inside: avoid; /* Try to keep card content from splitting across pages */
            }
             .metric-card p {
                font-size: 1.5em !important; /* Adjust for print */
            }

            .ess-blocks-wrapper {
                padding: 10px !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
                background-color: #fff !important;
            }
            #ess-blocks-diagrams-container, #ess-blocks-details-text-container {
                padding: 5px !important;
                border: none !important; /* Remove borders from inner containers if wrapper has one */
            }

            #ess-blocks-diagrams.mermaid svg {
                display: block !important;
                max-width: 100% !important;
                height: auto !important;
            }
            /* Adjust link colors for print - typically black or dark gray */
            a, a:visited {
                color: #333 !important;
                text-decoration: none; /* Optional: remove underline for cleaner print */
            }
            /* Specific overrides for mermaid theme variables for print if needed, though 'base' is usually fine */
        }

        /* --- PDF Capture Helper Styles --- */
        .prepare-for-pdf-capture,
        .prepare-for-pdf-capture * {
            animation: none !important;
            transition: none !important;
            transform: none !important; /* Avoid transforms that might affect rendering */
            opacity: 1 !important; /* Ensure full opacity */
            /* overflow: visible !important;  Potentially helps capture all content, but use with caution */
        }
        .prepare-for-pdf-capture .main-header, /* Hide header during PDF capture */
        .prepare-for-pdf-capture .main-footer, /* Hide footer during PDF capture */
        .prepare-for-pdf-capture #download-report-button { /* Hide the button itself */
            display: none !important;
        }
        .prepare-for-pdf-capture .animate-on-scroll{
            opacity: 1 !important; /* Ensure animated sections are fully visible */
            transform: translateY(0) !important;
        }
        /* Optional: Spinner for loading indication */
        .spinner {
            display: inline-block;
            border: 3px solid #f3f3f3; /* Light grey */
            border-top: 3px solid var(--primary-color); /* Orange */
            border-radius: 50%;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
            margin-left: 5px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header id="main-header" class="main-header">
        <div class="header-container">
            <a href="#hero" class="logo-link">
                <img src="logo.png" alt="阳光储能 Logo" class="logo"> </a>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="#hero" class="nav-link">首页</a></li>
                    <li><a href="#project-inputs-section" class="nav-link">项目配置</a></li>
                    <li><a href="#results-area" class="nav-link">配置结果</a></li>
                    <li><a href="#" id="download-report-button" class="nav-link">下载报告</a></li>
                </ul>
            </nav>
            <button class="menu-toggle" id="menu-toggle" aria-label="Toggle menu" aria-expanded="false">
                <span class="menu-icon-bar"></span>
                <span class="menu-icon-bar"></span>
                <span class="menu-icon-bar"></span>
            </button>
        </div>
    </header>

    <main>
        <section id="hero" class="hero-section">
            <div class="hero-content animate-on-scroll">
                <h1 class="hero-title">储能系统方案配置工具</h1>
                <p class="hero-subtitle">诚恳务实、严谨开放、创新尊重、成就客户</p>
                <a href="#project-inputs-section" class="btn btn-primary btn-hero">开始配置</a>
            </div>
        </section>

        <section id="project-inputs-section" class="content-section">
            <div class="section-container">
                <div class="animate-on-scroll">
                    <h2 class="section-title">项目参数输入</h2>
                    <p class="section-intro">请提供您的项目体量，智能系统将为您配置最优方案，助您实现项目效益最大化。</p>
                </div>
                <div id="project-inputs" class="input-form-grid animate-on-scroll">
                    <div class="input-group">
                        <label for="project_power_mw">项目储能功率 (MW):</label>
                        <input type="number" id="project_power_mw" name="project_power_mw" value="50" class="form-input">
                    </div>
                    <div class="input-group">
                        <label for="project_capacity_mwh">项目储能容量 (MWh):</label>
                        <input type="number" id="project_capacity_mwh" name="project_capacity_mwh" value="100" class="form-input">
                    </div>
                    <div class="input-group device-sets-group">
                        <div class="device-sets-container">
                            <div class="device-sets-header">
                                <span class="device-sets-title">设备套数限制</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enable_device_sets_limit">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="device-sets-input-area disabled" id="device-sets-input-area">
                                <label for="max_device_sets">允许最大设备套数:</label>
                                <input type="number" id="max_device_sets" name="max_device_sets" value="100" min="1" max="1000" class="form-input" disabled>
                            </div>
                            <div class="min-sets-hint" id="min-sets-hint">
                                💡 建议最小设备套数: <span id="min-sets-value">-</span> 套
                            </div>
                        </div>
                    </div>
                    <div class="input-group system-selection-group">
                        <label for="system_selection">系统选择:</label>
                        <select id="system_selection" name="system_selection" class="form-select">
                            <option value="5mw">5MW系统</option>
                            <option value="7.5mw">7.5MW系统</option>
                            <option value="overall">总体最优</option>
                        </select>
                    </div>
                    <div class="input-group button-group">
                        <label style="opacity: 0; pointer-events: none;">占位</label>
                        <button id="calculate-button" class="btn btn-primary">计算最优方案</button>
                    </div>
                </div>
            </div>
        </section>

        <div id="results-area" style="display:none;"> 
            <section id="solution-summary-metrics" class="content-section results-summary-section">
                <div class="section-container">
                    <div class="animate-on-scroll">
                        <h2 class="section-title">方案核心指标</h2>
                    </div>
                    <div id="solution-message" class="message-info animate-on-scroll"></div>
                    <div class="metrics-container animate-on-scroll">
                        <div class="metric-card">
                            <h4>用户输入功率</h4>
                            <p id="summary-input-power">-</p>
                            <span>MW</span>
                        </div>
                        <div class="metric-card">
                            <h4>用户输入容量</h4>
                            <p id="summary-input-capacity">-</p>
                            <span>MWh</span>
                        </div>
                        <div class="metric-card">
                            <h4>配置总功率</h4>
                            <p id="summary-config-power">-</p>
                            <span>MW</span>
                        </div>
                        <div class="metric-card" id="actual-power-card" style="display:none;">
                            <h4>实际功率输出</h4>
                            <p id="summary-actual-power">-</p>
                            <span>MW</span>
                            <div class="metric-note" id="actual-power-note" style="display:none; font-size: 0.8em; color: #666; margin-top: 4px;"></div>
                        </div>
                        <div class="metric-card">
                            <h4>配置总容量</h4>
                            <p id="summary-config-capacity">-</p>
                            <span>MWh</span>
                        </div>
                        <div class="metric-card">
                            <h4>系统倍率</h4>
                            <p id="summary-system-hour-type">-</p>
                            <span>小时</h1></span>
                        </div>
                         <div class="metric-card" id="total-cost-card" style="display:none;">
                            <h4>总等效成本</h4>
                            <p id="summary-total-cost">-</p>
                            <span>MWh (等效)</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="configuration-details" class="content-section">
                <div class="section-container">
                    <div class="animate-on-scroll">
                        <h2 class="section-title">配置详情</h2>
                    </div>
                    <div class="details-grid"> <div class="component-section animate-on-scroll" id="ac-side-container" style="display:none;">
                            <h3>交流侧 (一体舱)</h3>
                            <ul id="ac-side-list" class="component-list"></ul>
                        </div>

                        <div class="component-section animate-on-scroll" id="dc-side-container" style="display:none;">
                            <h3>直流侧 (电池舱)</h3>
                            <ul id="dc-side-list" class="component-list"></ul>
                        </div>
                    </div>

                    <div class="animate-on-scroll" id="ess-blocks-container" style="display:none; margin-top: 40px;">
                        <h3 class="section-title" id="ess-blocks-section-title" style="font-size: 1.8rem; margin-bottom: 1.5em;">储能单元块构成</h3>
                        <div class="ess-blocks-wrapper">
                            <div id="ess-blocks-diagrams-container">
                                <div id="ess-blocks-diagrams" class="mermaid"></div>
                            </div>
                            <div id="ess-blocks-details-text-container">
                                </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="solution-parameters" class="content-section" style="display:none; background-color: var(--bg-color-medium);">
                 <div class="section-container">
                    <div class="animate-on-scroll">
                        <h2 class="section-title">方案说明与选型</h2>
                    </div>
                    <div class="parameters-list animate-on-scroll" style="background-color: var(--bg-color-card); border: 1px solid var(--border-color-soft); box-shadow: 0 6px 20px rgba(0,0,0,0.06); padding: clamp(25px, 4vw, 35px); border-radius: var(--border-radius);">
                        <p><strong>储能系统:</strong> <span id="param-dc-family">-</span></p>
                        <p><strong>直流侧电池舱选用规格:</strong> <span id="param-chosen-dc-specs">-</span></p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="main-footer">
        <div class="footer-container animate-on-scroll">
            <div class="footer-content">
                <p>储能系统方案配置工具 V1.0 &copy; 2025.5</p> <div class="author-info">
                    <p>作者: 卢文博 | <a href="mailto:luwenbo@sungrowpower.com">luwenbo@sungrowpower.com</a></p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4HCuv1SF4M5SxB3fq1uOL+I1GPhAWpW7idsSayYHQeLfL+RxoGfL1L311A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        // --- Animation & Interaction Script ---
        document.addEventListener('DOMContentLoaded', () => {
            window.scrollTo(0, 0); // Ensure page loads at the top
            
            // --- 设备套数限制开关控制 ---
            const enableDeviceSetsLimit = document.getElementById('enable_device_sets_limit');
            const deviceSetsInputArea = document.getElementById('device-sets-input-area');
            const maxDeviceSetsInput = document.getElementById('max_device_sets');
            const minSetsHint = document.getElementById('min-sets-hint');
            const minSetsValue = document.getElementById('min-sets-value');
            
            // 开关状态变化处理
            enableDeviceSetsLimit.addEventListener('change', function() {
                if (this.checked) {
                    deviceSetsInputArea.classList.remove('disabled');
                    maxDeviceSetsInput.disabled = false;
                    updateMinDeviceSetsHint(); // 开启时立即更新提示，确保最大套数合理
                } else {
                    deviceSetsInputArea.classList.add('disabled');
                    maxDeviceSetsInput.disabled = true;
                    // 关闭限制时隐藏最小套数提示
                    minSetsHint.classList.remove('show');
                }
            });

            // 功率和容量输入变化时更新最小设备套数提示
            const projectPowerInput = document.getElementById('project_power_mw');
            const projectCapacityInput = document.getElementById('project_capacity_mwh');
            
            function updateMinDeviceSetsHint() {
                // 只有在开启设备套数限制时才计算和显示最小设备套数
                if (!enableDeviceSetsLimit.checked) {
                    minSetsHint.classList.remove('show');
                    return;
                }
                
                const power = parseFloat(projectPowerInput.value) || 0;
                const capacity = parseFloat(projectCapacityInput.value) || 0;
                
                if (power > 0 && capacity > 0) {
                    // 计算最小设备套数（简化版本，与后端逻辑对应）
                    const maxSingleBlockPower = 7.5; // 7.5MW是最大的PCS功率
                    const maxSingleBlockCapacity = 7.523; // 7.5MWh是最大的单个电池舱容量
                    const duration = capacity / power;
                    const systemHourType = duration <= 1.5 ? 1 : (duration <= 3.0 ? 2 : 4);
                    const maxCapacityPerBlock = maxSingleBlockCapacity * systemHourType;
                    
                    const minSetsForPower = Math.ceil(power / maxSingleBlockPower);
                    const minSetsForCapacity = Math.ceil(capacity / maxCapacityPerBlock);
                    const minSets = Math.max(minSetsForPower, minSetsForCapacity, 1);
                    
                    minSetsValue.textContent = minSets;
                    minSetsHint.classList.add('show');
                    
                    // 如果启用了设备套数限制且当前设置的最大套数小于最小套数，自动调整
                    if (parseInt(maxDeviceSetsInput.value) < minSets) {
                        maxDeviceSetsInput.value = minSets;
                    }
                } else {
                    minSetsHint.classList.remove('show');
                }
            }
            
            projectPowerInput.addEventListener('input', updateMinDeviceSetsHint);
            projectCapacityInput.addEventListener('input', updateMinDeviceSetsHint);
            
            // 页面加载时不自动显示最小设备套数提示，只有开启限制时才显示

            const animatedElements = document.querySelectorAll('.animate-on-scroll');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    }
                });
            }, { threshold: 0.1 });
            animatedElements.forEach(el => { observer.observe(el); });

            const header = document.getElementById('main-header');
            window.addEventListener('scroll', () => {
                header.classList.toggle('scrolled', window.scrollY > 50);
            });

            const menuToggle = document.getElementById('menu-toggle');
            const mainNav = document.getElementById('main-nav');
            if (menuToggle && mainNav) {
                menuToggle.addEventListener('click', () => {
                    const isActive = mainNav.classList.toggle('is-active');
                    menuToggle.classList.toggle('is-active', isActive);
                    menuToggle.setAttribute('aria-expanded', isActive);
                });
            }

            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (mainNav.classList.contains('is-active') && !link.id !== 'download-report-button') { // Do not close for download button as it's not a scroll target
                        mainNav.classList.remove('is-active');
                        menuToggle.classList.remove('is-active');
                        menuToggle.setAttribute('aria-expanded', 'false');
                    }
                });
            });
            
            const downloadReportButton = document.getElementById('download-report-button');
            if (downloadReportButton) {
                downloadReportButton.addEventListener('click', async function(event) {
                    event.preventDefault(); // Prevent default anchor behavior

                    const projectInputsSection = document.getElementById('project-inputs-section');
                    const resultsArea = document.getElementById('results-area');

                    if (!resultsArea || resultsArea.style.display === 'none') {
                        alert('请先生成配置结果，并确保结果区域可见，然后再下载报告。');
                        return;
                    }

                    const originalButtonText = this.textContent;
                    this.innerHTML = '正在生成PDF... <span class="spinner"></span>'; // Add a spinner or loading text
                    this.disabled = true;

                    document.body.classList.add('prepare-for-pdf-capture');

                    console.log("Attempting to use jsPDF. window.jspdf is:", window.jspdf); // Debugging line

                    try {
                        if (!window.jspdf || !window.jspdf.jsPDF) {
                            alert("jsPDF library not loaded correctly. Please check the console and ensure jsPDF is loaded before this script runs.");
                            throw new Error("jsPDF library not loaded or not exposing jsPDF constructor correctly.");
                        }
                        const { jsPDF } = window.jspdf; // Or: const jsPDF = window.jspdf.jsPDF;
                        const pdf = new jsPDF({
                            orientation: 'p',
                            unit: 'pt',
                            format: 'a4'
                        });

                        const commonHtml2CanvasOptions = {
                            scale: 2, // Improves image quality
                            useCORS: true,
                            logging: false,
                            scrollX: 0, // Ensure we capture from the top-left
                            scrollY: -window.scrollY, // Offset by current scroll position
                            windowWidth: document.documentElement.offsetWidth, // Capture full width
                            windowHeight: document.documentElement.offsetHeight, // Capture full height for calculation
                             onclone: (clonedDoc) => {
                                const diagrams = clonedDoc.querySelectorAll('.mermaid');
                                diagrams.forEach((diag) => {
                                    const svg = diag.querySelector('svg');
                                    if (svg) {
                                        // Ensure SVGs have explicit dimensions from their bounding box
                                        const actualDiag = document.getElementById(diag.id); // Get original from main DOM
                                        if(actualDiag){
                                            const rect = actualDiag.getBoundingClientRect();
                                            svg.style.width = rect.width + 'px';
                                            svg.style.height = rect.height + 'px';
                                        }
                                    }
                                });
                            }
                        };

                        // --- Capture Project Inputs Section ---
                        const canvasInputs = await html2canvas(projectInputsSection, commonHtml2CanvasOptions);
                        const imgDataInputs = canvasInputs.toDataURL('image/png');
                        const imgPropsInputs = pdf.getImageProperties(imgDataInputs);
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        let currentY = 0;
                        const pageMargin = 40; // pt, for top/bottom margins
                        let remainingPageHeight = pdf.internal.pageSize.getHeight() - (2 * pageMargin);

                        let sectionHeightInputs = (imgPropsInputs.height * pdfWidth) / imgPropsInputs.width;
                        pdf.addImage(imgDataInputs, 'PNG', pageMargin, pageMargin + currentY, pdfWidth - (2*pageMargin), sectionHeightInputs);
                        currentY += sectionHeightInputs + 20; // Add some space after this section

                        // --- Capture Results Area --- 
                        // Ensure results area is fully visible and not affected by animations for capture
                        resultsArea.style.display = 'block'; // Ensure it is displayed

                        const canvasResults = await html2canvas(resultsArea, commonHtml2CanvasOptions);
                        const imgDataResults = canvasResults.toDataURL('image/png');
                        const imgPropsResults = pdf.getImageProperties(imgDataResults);
                        let sectionHeightResults = (imgPropsResults.height * pdfWidth) / imgPropsResults.width;

                        // Check if results fit on current page or need new page
                        if (currentY + sectionHeightResults > remainingPageHeight) {
                            pdf.addPage();
                            currentY = 0; // Reset Y for new page
                        }
                        pdf.addImage(imgDataResults, 'PNG', pageMargin, pageMargin + currentY, pdfWidth - (2*pageMargin), sectionHeightResults);

                        pdf.save('储能系统配置报告.pdf');

                    } catch (error) {
                        console.error("PDF生成失败:", error);
                        alert("PDF生成失败，详情请查看控制台。\n错误: " + error.message);
                    } finally {
                        this.textContent = originalButtonText;
                        this.disabled = false;
                        document.body.classList.remove('prepare-for-pdf-capture');
                    }
                });
            }
            
            const sections = document.querySelectorAll('main section[id], div#results-area');
            function navHighlighter() {
                let scrollY = window.pageYOffset;
                let activeSectionId = null;

                sections.forEach(current => {
                    const sectionHeight = current.offsetHeight;
                    const sectionTop = current.offsetTop - (header.offsetHeight + 70) ; // Increased offset slightly
                    let sectionId = current.getAttribute('id');
                    
                    if (scrollY >= sectionTop && scrollY < sectionTop + sectionHeight){
                       activeSectionId = sectionId;
                    }
                });
                if (scrollY < (document.getElementById('project-inputs-section')?.offsetTop - (header.offsetHeight + 70) || 200)) {
                    activeSectionId = 'hero';
                }

                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if(link.getAttribute('href') === `#${activeSectionId}`) {
                        link.classList.add('active');
                    }
                });
            }
            window.addEventListener('scroll', navHighlighter);
            navHighlighter();
        }); 

        // --- Pyodide & Calculation Script ---
        let pyodideInstance = null; 

        const rootStyles = getComputedStyle(document.documentElement);
        const primaryColorVal = rootStyles.getPropertyValue('--primary-color').trim();
        const textColorLightVal = rootStyles.getPropertyValue('--text-color-light').trim();
        const primaryColorDarkVal = rootStyles.getPropertyValue('--primary-color-dark').trim();
        const accentColorTealVal = rootStyles.getPropertyValue('--accent-color-teal').trim();

        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'base', // Using 'base' for more CSS control
            fontFamily: '"Noto Sans SC", sans-serif',
            flowchart: { 
                htmlLabels: true, 
                useMaxWidth: false // Set to false and control width via CSS on the svg
            },
            themeVariables: {
                // Node colors - using accent yellow for background, primary orange for border
                primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color-yellow').trim(),
                primaryTextColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color-headings').trim(),
                primaryBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                
                // Line/arrow color - using primary orange
                lineColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                
                // General text color within nodes if not covered by primaryTextColor (should be same)
                textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color-headings').trim(), 
                fontSize: '14px',
                
                // Subgraph/cluster colors - using a very light primary orange for background, primary orange for border
                clusterBkg: getComputedStyle(document.documentElement).getPropertyValue('--primary-color-extralight').trim(), // Assumes --primary-color-extralight is defined
                clusterBorder: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim()
            },
            classDefs: {
                pcsNodeStyle: 'fill:#FF0000,color:#FFFFFF,stroke:#AA0000,stroke-width:2px', // 测试用亮红色
                dcNodeStyle: 'fill:#0000FF,color:#FFFFFF,stroke:#0000AA,stroke-width:2px'  // 测试用亮蓝色
            }
        });

        async function mainPyodide() {
            const calculateButton = document.getElementById("calculate-button");
            const resultsArea = document.getElementById("results-area");
            const solutionMessage = document.getElementById("solution-message");
            
            const summaryInputPower = document.getElementById("summary-input-power");
            const summaryInputCapacity = document.getElementById("summary-input-capacity");
            const summaryConfigPower = document.getElementById("summary-config-power");
            const summaryActualPower = document.getElementById("summary-actual-power");
            const actualPowerCard = document.getElementById("actual-power-card");
            const actualPowerNote = document.getElementById("actual-power-note");
            const summaryConfigCapacity = document.getElementById("summary-config-capacity");
            const summaryTotalCost = document.getElementById("summary-total-cost");
            const totalCostCard = document.getElementById("total-cost-card");
            const summarySystemHourType = document.getElementById("summary-system-hour-type");

            const acSideContainer = document.getElementById("ac-side-container");
            const acSideList = document.getElementById("ac-side-list");
            const dcSideContainer = document.getElementById("dc-side-container");
            const dcSideList = document.getElementById("dc-side-list");
            
            const essBlocksContainer = document.getElementById("ess-blocks-container"); // The main section
            const essBlocksDiagrams = document.getElementById("ess-blocks-diagrams"); // Where SVG goes
            const essBlocksDetailsTextContainer = document.getElementById("ess-blocks-details-text-container"); // Where text list goes

            const solutionParametersSection = document.getElementById("solution-parameters");
            const paramDcFamily = document.getElementById("param-dc-family");
            const paramChosenDcSpecs = document.getElementById("param-chosen-dc-specs");
            const systemSelection = document.getElementById("system_selection");

            // 添加设备套数相关的变量声明
            const enableDeviceSetsLimit = document.getElementById('enable_device_sets_limit');
            const minSetsHint = document.getElementById('min-sets-hint');
            const minSetsValue = document.getElementById('min-sets-value');

            calculateButton.textContent = "加载计算引擎...";
            calculateButton.disabled = true;
            solutionMessage.textContent = "正在初始化计算引擎...";
            solutionMessage.className = "message-info"; 

            try {
                pyodideInstance = await loadPyodide(); 
                await pyodideInstance.loadPackage("micropip");
                
                const pythonScriptResponse = await fetch("./all_sys.py"); 
                if (!pythonScriptResponse.ok) {
                    throw new Error(`无法加载Python脚本: ${pythonScriptResponse.statusText}`);
                }
                const pythonScript = await pythonScriptResponse.text();
                pyodideInstance.runPython(pythonScript);
                console.log("Python script loaded and executed by Pyodide.");

                calculateButton.textContent = "计算最优方案";
                calculateButton.disabled = false;
                solutionMessage.textContent = "引擎加载完毕，请输入参数后点击计算。";
                solutionMessage.className = "message-success";

            } catch (error) {
                 console.error("Pyodide initialization error:", error);
                 calculateButton.textContent = "引擎加载失败";
                 calculateButton.disabled = true;
                 solutionMessage.textContent = "计算引擎加载失败: " + error.message;
                 solutionMessage.className = "message-error";
                 return; 
            }

            calculateButton.addEventListener("click", async () => {
                if (!pyodideInstance || !pyodideInstance.globals) { 
                    solutionMessage.textContent = "计算引擎未就绪，请刷新页面。";
                    solutionMessage.className = "message-error";
                    console.error("Pyodide instance not available for calculation.");
                    return;
                }

                const projectPowerMw = parseFloat(document.getElementById("project_power_mw").value);
                const projectCapacityMwh = parseFloat(document.getElementById("project_capacity_mwh").value);
                const enableLimit = document.getElementById("enable_device_sets_limit").checked;
                const maxDeviceSets = enableLimit ? (parseInt(document.getElementById("max_device_sets").value) || 100) : 100;
                const selectedSystemValue = systemSelection.value;

                if (isNaN(projectPowerMw) || isNaN(projectCapacityMwh) || projectPowerMw <= 0 || projectCapacityMwh <= 0) {
                    solutionMessage.textContent = "请输入有效的正数项目功率和容量。";
                    solutionMessage.className = "message-warning";
                    resultsArea.style.display = "block"; 
                    document.getElementById("solution-summary-metrics").style.display = "block"; 
                    acSideContainer.style.display = "none";
                    dcSideContainer.style.display = "none";
                    essBlocksContainer.style.display = "none";
                    solutionParametersSection.style.display = "none";
                    summaryInputPower.textContent = "-";
                    summaryInputCapacity.textContent = "-";
                    summaryConfigPower.textContent = "-";
                    summaryConfigCapacity.textContent = "-";
                    summaryTotalCost.textContent = "-";
                    totalCostCard.style.display = selectedSystemValue === "overall" ? "block" : "none";
                    summarySystemHourType.textContent = "-";
                    // 清除实际功率输出显示
                    summaryActualPower.textContent = "-";
                    actualPowerCard.style.display = "none";
                    actualPowerNote.style.display = "none";
                    return;
                }

                resultsArea.style.display = "block";
                resultsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                solutionMessage.textContent = "正在计算中，请稍候...";
                solutionMessage.className = "message-info";
                document.getElementById("solution-summary-metrics").style.display = "block";

                summaryInputPower.textContent = projectPowerMw.toFixed(2);
                summaryInputCapacity.textContent = projectCapacityMwh.toFixed(2);
                ['summary-config-power', 'summary-config-capacity', 'summary-total-cost', 'summary-system-hour-type', 'param-dc-family', 'param-chosen-dc-specs'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = "-";
                });
                // 清除实际功率输出显示
                summaryActualPower.textContent = "-";
                actualPowerCard.style.display = "none";
                actualPowerNote.style.display = "none";
                totalCostCard.style.display = selectedSystemValue === "overall" ? "block" : "none";
                acSideList.innerHTML = ""; dcSideList.innerHTML = "";
                essBlocksDiagrams.innerHTML = ""; 
                if(essBlocksDetailsTextContainer) essBlocksDetailsTextContainer.innerHTML = ""; // Clear new container

                acSideContainer.style.display = "none"; dcSideContainer.style.display = "none";
                essBlocksContainer.style.display = "none"; solutionParametersSection.style.display = "none";


                try {
                    let resultJs;
                    if (selectedSystemValue === "5mw") {
                        resultJs = pyodideInstance.globals.get("get_optimal_solution_for_dc_family")("5MW", projectPowerMw, projectCapacityMwh, maxDeviceSets);
                    } else if (selectedSystemValue === "7.5mw") {
                        resultJs = pyodideInstance.globals.get("get_optimal_solution_for_dc_family")("7.5MW", projectPowerMw, projectCapacityMwh, maxDeviceSets);
                    } else { 
                        resultJs = pyodideInstance.globals.get("get_overall_optimal_solution")(projectPowerMw, projectCapacityMwh, maxDeviceSets);
                    }
                    
                    const jsProxyToJs = (x) => {
                        if (x instanceof pyodideInstance.ffi.PyProxy) { 
                            if (x.type === "dict") return x.toJs({ dict_converter: Object.fromEntries });
                            if (x.type === "list" || x.type === "tuple") return x.toJs();
                        }
                        return x;
                    };
                    const finalResult = jsProxyToJs(resultJs);
                    console.log("Processed result from Python:", finalResult);

                    // 更新最小设备套数显示（使用后端精确计算的值）
                    if (finalResult.min_device_sets !== undefined && enableDeviceSetsLimit.checked) {
                        minSetsValue.textContent = finalResult.min_device_sets;
                        minSetsHint.classList.add('show');
                    }

                    solutionMessage.textContent = "计算完成。";
                    solutionMessage.className = (finalResult.cost === Infinity || finalResult.cost == null) ? "message-error" : "message-success";


                    if (finalResult.cost === Infinity || finalResult.cost == null) {
                        document.getElementById("solution-summary-metrics").style.display = "block"; 
                        return; 
                    }

                    if (finalResult.power !== undefined) summaryConfigPower.textContent = finalResult.power.toFixed(2);
                    
                    // 计算和显示实际功率输出
                    if (finalResult.power !== undefined && finalResult.block_details_for_display && finalResult.system_hour_type !== undefined) {
                        let actualPowerOutput = 0;
                        let hasReducedClusterConfig = false;
                        
                        // 计算实际功率输出
                        finalResult.block_details_for_display.forEach(blockDetail => {
                            const blockCount = blockDetail.count;
                            const pcsRatedPower = blockDetail.pcs_power_mw;
                            let blockDcCapacity = 0;
                            
                            // 计算单个块的直流容量
                            blockDetail.dc_containers.forEach(dc => {
                                blockDcCapacity += dc.count_in_block * dc.capacity_per_unit;
                            });
                            
                            // 检查是否包含减簇配置
                            blockDetail.dc_containers.forEach(dc => {
                                // 简化检查：如果名称包含"减"字，认为是减簇配置
                                if (dc.name_cn && dc.name_cn.includes('减')) {
                                    hasReducedClusterConfig = true;
                                }
                            });
                            
                            // 统一公式：min(PCS额定功率, 直流容量÷系统时长)
                            let actualBlockPower;
                            if (finalResult.system_hour_type > 0) {
                                const dcLimitedPower = blockDcCapacity / finalResult.system_hour_type;
                                actualBlockPower = Math.min(pcsRatedPower, dcLimitedPower);
                            } else {
                                actualBlockPower = pcsRatedPower;
                            }
                            
                            actualPowerOutput += blockCount * actualBlockPower;
                        });
                        
                        actualPowerOutput = Math.round(actualPowerOutput * 100) / 100; // 两位小数精度
                        
                        // 显示实际功率输出
                        summaryActualPower.textContent = actualPowerOutput.toFixed(2);
                        actualPowerCard.style.display = "block";
                        
                        // 移除提示信息
                        actualPowerNote.textContent = "";
                        actualPowerNote.style.display = "none";

                    } else {
                        actualPowerCard.style.display = "none";
                    }

                    if (finalResult.capacity !== undefined) summaryConfigCapacity.textContent = finalResult.capacity.toFixed(2);
                    if (finalResult.system_hour_type !== undefined) summarySystemHourType.textContent = finalResult.system_hour_type;
                    
                    let dcFamilyForDisplay = finalResult.dc_family_technology || "-";
                    if (finalResult.dc_family_technology === "5MW") dcFamilyForDisplay = "PowerTitan2.0液冷储能系统";
                    else if (finalResult.dc_family_technology === "7.5MW") dcFamilyForDisplay = "PowerTitan2.0拓展版液冷储能系统";
                    paramDcFamily.textContent = dcFamilyForDisplay;
                    paramChosenDcSpecs.textContent = finalResult.chosen_global_dc_specs ? finalResult.chosen_global_dc_specs.join(", ") : "-";
                    solutionParametersSection.style.display = "block";
                    
                    if (selectedSystemValue === "overall" && finalResult.cost !== undefined) {
                        summaryTotalCost.textContent = finalResult.cost.toFixed(2);
                        totalCostCard.style.display = "block";
                    } else {
                        totalCostCard.style.display = "none";
                    }

                    if (finalResult.block_details_for_display && finalResult.block_details_for_display.length > 0) {
                        essBlocksContainer.style.display = "block"; // Show the main section container
                        acSideContainer.style.display = "block";
                        dcSideContainer.style.display = "block";
                        
                        const pcsComponents = {};
                        const dcComponents = {};
                        // Mermaid diagram title includes dynamic values from user input
                        let mermaidDiagram = `graph TD\n    subgraph "储能单元构成 (${dcFamilyForDisplay} - ${projectPowerMw}MW / ${projectCapacityMwh}MWh)"\n    direction LR\n`;
                        let blockCounter = 0;
                        let subGraphCounter = 0;

                        finalResult.block_details_for_display.forEach(blockDetail => {
                            const blockKey = `B${blockCounter++}`;
                            mermaidDiagram += `    subgraph ${blockKey}_Sub["${blockDetail.block_description} (x${blockDetail.count})"]\n    direction LR\n`; // Removed "单元块类型:" prefix for cleaner look
                            const pcsKey = `PCS_${blockKey}`;
                            mermaidDiagram += `        ${pcsKey}["${blockDetail.pcs_name_cn} (x1)"]:::pcsNodeStyle\n`; 

                            pcsComponents[blockDetail.pcs_name_cn] = (pcsComponents[blockDetail.pcs_name_cn] || { count: 0, power_per_unit: blockDetail.pcs_power_mw });
                            pcsComponents[blockDetail.pcs_name_cn].count += blockDetail.count;

                            blockDetail.dc_containers.forEach(dc => {
                                const dcKey = `DC_${dc.name_cn.replace(/\W/g, "")}_${blockKey}_${subGraphCounter++}`;
                                mermaidDiagram += `        ${pcsKey} --> ${dcKey}["${dc.name_cn} (x${dc.count_in_block})<br>容量: ${dc.capacity_per_unit.toFixed(3)} MWh"]:::dcNodeStyle\n`;

                                dcComponents[dc.name_cn] = (dcComponents[dc.name_cn] || { count: 0, capacity_per_unit: dc.capacity_per_unit });
                                dcComponents[dc.name_cn].count += blockDetail.count * dc.count_in_block;
                            });
                            mermaidDiagram += `    end\n`;
                        });
                        mermaidDiagram += `    end`; 

                        essBlocksDiagrams.innerHTML = ""; 
                        essBlocksDiagrams.removeAttribute('data-processed');
                        try {
                            const { svg } = await mermaid.render("mermaid-diag-" + Date.now(), mermaidDiagram);
                            essBlocksDiagrams.innerHTML = svg;
                        } catch (e) {
                            console.error("Mermaid rendering error:", e);
                            essBlocksDiagrams.innerHTML = `<p style='color:red; font-weight:bold;'>图表渲染失败:</p><p style='color:red;'>${e.message}</p><pre style='font-size:0.8em; color:#333; white-space:pre-wrap;'>${mermaidDiagram}</pre>`;
                        }

                        let detailsTextHTML = "<p><strong>储能单元块详细构成:</strong></p><ul>";
                        finalResult.block_details_for_display.forEach(bd => { detailsTextHTML += `<li>${bd.count} x [${bd.block_description}]</li>`; });
                        detailsTextHTML += "</ul>";
                        if(essBlocksDetailsTextContainer) essBlocksDetailsTextContainer.innerHTML = detailsTextHTML;


                        acSideList.innerHTML = "";
                        for (const [name, data] of Object.entries(pcsComponents)) {
                            const li = document.createElement("li");
                            li.textContent = `${name}: ${data.count}台 (单台功率: ${data.power_per_unit.toFixed(3)} MW, 总计: ${(data.count * data.power_per_unit).toFixed(3)} MW)`;
                            acSideList.appendChild(li);
                        }
                        dcSideList.innerHTML = "";
                        for (const [name, data] of Object.entries(dcComponents)) {
                            const li = document.createElement("li");
                            li.textContent = `${name}: ${data.count}个 (单台容量: ${data.capacity_per_unit.toFixed(3)} MWh, 总计: ${(data.count * data.capacity_per_unit).toFixed(3)} MWh)`;
                            dcSideList.appendChild(li);
                        }
                    } else {
                        essBlocksContainer.style.display = "none";
                        acSideContainer.style.display = "none";
                        dcSideContainer.style.display = "none";
                    }
                } catch (error) {
                    console.error("Error during calculation or display:", error);
                    solutionMessage.textContent = "计算或显示结果时出错: " + error.message;
                    solutionMessage.className = "message-error";
                    document.getElementById("solution-summary-metrics").style.display = "block"; 
                    acSideContainer.style.display = "none";
                    dcSideContainer.style.display = "none";
                    essBlocksContainer.style.display = "none";
                    solutionParametersSection.style.display = "none";
                    // 清除实际功率输出显示
                    summaryActualPower.textContent = "-";
                    actualPowerCard.style.display = "none";
                    actualPowerNote.style.display = "none";
                }
            });
        }
        document.addEventListener('DOMContentLoaded', mainPyodide);
    </script>
</body>
</html>