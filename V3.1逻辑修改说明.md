# V3.1 逻辑修改说明（待审核）

## 修改概述

**版本**: V3.0 → V3.1  
**核心变更**: 新增2.5MW PCS配置，为7.5MW家族提供更精细的功率步长  
**修改范围**: 仅后端计算逻辑

---

## 1. 新增组件定义

### 1.1 新增PCS规格

| 型号 | 额定功率 (MW) | 等效容量 (MWh) | 中文名称 | 说明 |
|------|--------------|---------------|---------|------|
| PCS_2_5MW | 2.5 | 0.625 | 2.5MW逆变升压一体舱 | **V3.1新增** |

**等效容量计算**: 2.5MW × 0.25h = 0.625 MWh（与其他PCS保持相同的等效系数）

---

## 2. 配置规则修改

### 2.1 PCS与电池舱家族兼容性（更新）

| PCS类型 | 可配合电池舱家族 | 说明 |
|---------|----------------|------|
| PCS_5MW | 5MW家族、7.5MW家族 | 通用PCS |
| PCS_7_5MW | 仅7.5MW家族 | 大功率PCS |
| **PCS_2_5MW** | **仅7.5MW家族** | **V3.1新增**：小功率PCS |

### 2.2 2.5MW PCS特定配置（新增）

针对7.5MW家族，增加以下三种固定配置：

#### 配置1：2h系统
- **PCS**: PCS_2_5MW（2.5MW，等效容量0.625MWh）
- **电池舱**: 1个 ST7523UX_7_5MW_6R（减6簇，5.015MWh）
- **单元块功率**: 2.5 MW
- **单元块容量**: 5.015 MWh
- **单元块等效容量**: 0.625 + 5.015 = 5.640 MWh
- **功率校验**: 5.015 ÷ 2h = 2.5075 MW ≈ 2.5 MW ✓

#### 配置2：4h系统
- **PCS**: PCS_2_5MW（2.5MW，等效容量0.625MWh）
- **电池舱**: 2个 ST7523UX_7_5MW_6R（减6簇，每个5.015MWh）
- **单元块功率**: 2.5 MW
- **单元块容量**: 2 × 5.015 = 10.030 MWh
- **单元块等效容量**: 0.625 + 10.030 = 10.655 MWh
- **功率校验**: 10.030 ÷ 4h = 2.5075 MW ≈ 2.5 MW ✓

#### 配置3：6h系统
- **PCS**: PCS_2_5MW（2.5MW，等效容量0.625MWh）
- **电池舱**: 2个 ST7523UX_7_5MW_0R（不减簇，每个7.5225MWh）
- **单元块功率**: 2.5 MW
- **单元块容量**: 2 × 7.5225 = 15.045 MWh
- **单元块等效容量**: 0.625 + 15.045 = 15.670 MWh
- **功率校验**: 15.045 ÷ 6h = 2.5075 MW ≈ 2.5 MW ✓

**注意**: 
- 2h和4h系统使用减6簇电池舱
- 6h系统使用不减簇电池舱

### 2.3 6h系统规则更新

**修改前（V3.0）:**
- 允许PCS类型：仅PCS_5MW
- PCS_5MW最多配4个电池舱

**修改后（V3.1）:**
- 允许PCS类型：PCS_5MW、**PCS_2_5MW**
- PCS_5MW最多配4个电池舱
- **PCS_2_5MW最多配2个电池舱（7.5MWh不减簇）**

---

## 3. 成本计算（保持不变）

2.5MW PCS配置使用与7.5MW家族相同的单价：

| 系统时长类型 | 7.5MW家族单价 (元/Wh) |
|------------|---------------------|
| 2h | 0.46 |
| 4h | 0.41 |
| 6h | 0.41 |

**成本计算公式**:
```
单元块真实成本 (万元) = 单元块等效容量 (MWh) × 100 × 单价 (元/Wh)
```

---

## 4. 配置价值分析

### 4.1 功率步长对比

| 配置方式 | 最小功率步长 | 说明 |
|---------|------------|------|
| V3.0及之前 | 5 MW | 仅支持5MW和7.5MW步长 |
| **V3.1** | **2.5 MW** | 新增2.5MW步长 |

### 4.2 应用场景

1. **小型项目精确匹配**
   - 7.5MW、10MW、12.5MW等项目无需过配
   - 减少设备冗余，降低成本

2. **大型项目功率补齐**
   - 例如：47.5MW项目 = 6×7.5MW + 1×2.5MW
   - 比使用10×5MW更经济

3. **成本优化**
   - 利用7.5MW家族的单价优势（0.46元/Wh vs 5MW的0.51元/Wh）
   - 即使等效容量相同，真实成本更低

4. **场地布局灵活性**
   - 更多小功率单元，便于分散布置
   - 适合分期建设

### 4.3 典型案例对比

#### 案例：7.5MW/15MWh 2h系统

| 方案 | PCS配置 | 电池舱配置 | 总等效容量 | 单价 | 总成本 | 过配情况 |
|------|--------|-----------|-----------|------|-------|---------|
| 5MW方案 | 2×5MW | 4个5MWh | 22.5 MWh | 0.51 | **1147.5万** | +2.5MW（+33%） |
| 7.5MW方案 | 1×7.5MW | 2个7.5MWh | 16.92 MWh | 0.46 | **778.32万** | 无过配 |
| **2.5MW方案** | 3×2.5MW | 3个7.5MWh | 16.92 MWh | 0.46 | **778.32万** | 无过配 |

**结论**:
- 2.5MW方案与7.5MW方案成本相同（778.32万）
- 比5MW方案节省：1147.5 - 778.32 = **369.18万元**（节省32.2%）
- 2.5MW方案设备更多（3套），可能更适合分期建设

#### 案例：10MW/40MWh 4h系统

| 方案 | PCS配置 | 电池舱配置 | 总等效容量 | 单价 | 总成本 | 成本节省 |
|------|--------|-----------|-----------|------|-------|---------|
| 5MW方案 | 2×5MW | 8个5MWh | 42.5 MWh | 0.43 | **1827.5万** | - |
| **2.5MW方案** | 4×2.5MW | 8个7.5MWh（减6簇） | 42.62 MWh | 0.41 | **1747.42万** | **节省80.08万** |

**结论**:
- 2.5MW方案利用7.5MW家族单价优势
- 节省4.4%成本

---

## 5. 代码实现要点

### 5.1 数据结构修改（all_sys.py）

#### 新增PCS定义
```python
PCS_SPECS = {
    "PCS_5MW": {"power_mw": 5.0, "equivalent_cost_mwh": 1.25, "name_cn": "5MW逆变升压一体舱"},
    "PCS_7_5MW": {"power_mw": 7.5, "equivalent_cost_mwh": 1.875, "name_cn": "7.5MW逆变升压一体舱"},
    "PCS_2_5MW": {"power_mw": 2.5, "equivalent_cost_mwh": 0.625, "name_cn": "2.5MW逆变升压一体舱"},  # V3.1新增
}
```

### 5.2 单元块生成逻辑修改

#### 修改函数：`generate_single_ess_block_configs()`

**新增逻辑**：对于7.5MW家族，增加2.5MW PCS的固定配置

**伪代码**：
```python
def generate_single_ess_block_configs(target_dc_family, system_hour_type):
    blocks = []
    
    # 现有逻辑：生成5MW和7.5MW PCS的配置
    # ...
    
    # V3.1新增：生成2.5MW PCS配置（仅7.5MW家族）
    if target_dc_family == "7.5MW":
        if system_hour_type == 2:
            # 2h系统：2.5MW + 1个减6簇
            block = create_2_5mw_block(
                pcs="PCS_2_5MW",
                dc_specs=["ST7523UX_7_5MW_6R"],  # 1个减6簇
                num_dc=1
            )
            blocks.append(block)
            
        elif system_hour_type == 4:
            # 4h系统：2.5MW + 2个减6簇
            block = create_2_5mw_block(
                pcs="PCS_2_5MW",
                dc_specs=["ST7523UX_7_5MW_6R"],  # 2个减6簇
                num_dc=2
            )
            blocks.append(block)
            
        elif system_hour_type == 6:
            # 6h系统：2.5MW + 2个不减簇
            block = create_2_5mw_block(
                pcs="PCS_2_5MW",
                dc_specs=["ST7523UX_7_5MW_0R"],  # 2个不减簇
                num_dc=2
            )
            blocks.append(block)
    
    return blocks
```

### 5.3 功率约束检查

2.5MW PCS配置需要通过功率约束检查：

```python
# 功率校验（以2h系统为例）
dc_capacity = 5.015  # 1个减6簇
required_power = dc_capacity / 2  # = 2.5075 MW
pcs_power = 2.5  # PCS额定功率
tolerance = 1.01

if required_power <= pcs_power * tolerance:  # 2.5075 <= 2.525
    # 通过检查 ✓
    pass
```

---

## 6. 影响范围评估

### 6.1 不受影响的部分
- ✅ 成本单价表（复用7.5MW家族单价）
- ✅ 成本计算公式
- ✅ 方案优选逻辑
- ✅ 输出格式
- ✅ 前端显示

### 6.2 需要修改的部分
- 📝 PCS规格定义（新增PCS_2_5MW）
- 📝 单元块生成函数（增加2.5MW固定配置）
- 📝 6h系统规则（允许PCS_2_5MW）

### 6.3 测试要点
1. **2h系统**: 7.5MW、10MW、12.5MW项目是否生成2.5MW配置
2. **4h系统**: 10MW、15MW、20MW项目是否生成2.5MW配置
3. **6h系统**: 15MW、20MW项目是否生成2.5MW配置
4. **功率校验**: 2.5MW配置是否通过功率约束
5. **成本对比**: 2.5MW配置与5MW/7.5MW配置的成本比较
6. **方案选择**: 系统是否能正确选择最优方案

---

## 7. 预期效果

### 7.1 配置灵活性提升
- 功率步长从5MW降至2.5MW
- 小型项目（≤20MW）过配问题显著改善

### 7.2 成本优化
- 小型项目成本可降低5%-30%（取决于具体功率需求）
- 大型项目通过精确补齐减少冗余

### 7.3 市场竞争力
- 提供更多配置选项
- 满足多样化项目需求
- 体现技术先进性

---

## 8. 风险评估

### 8.1 技术风险
- ⚠️ **低风险**: 2.5MW PCS是否为实际产品？
  - 建议：确认产品可行性
  
- ⚠️ **低风险**: 功率约束是否准确？
  - 已验证：2.5075MW ≈ 2.5MW，在1%容差内

### 8.2 实施风险
- ⚠️ **低风险**: 代码复杂度增加
  - 缓解：逻辑清晰，固定配置易维护
  
- ⚠️ **低风险**: 测试覆盖
  - 缓解：增加针对性测试用例

---

## 9. 后续建议

### 9.1 可选增强
1. **1.25MW步长**: 进一步细化（如果有1.25MW PCS产品）
2. **智能推荐**: 在多个方案成本相近时，推荐设备数量更少的方案
3. **分期建设优化**: 标注适合分期建设的配置

### 9.2 文档更新
- ✅ 计算逻辑说明文档（已更新）
- ⏳ 代码实现（待审核后进行）
- ⏳ 测试用例（待代码修改后添加）
- ⏳ V3.1更新说明（待整体完成后撰写）

---

## 10. 审核要点

请重点审核以下内容：

1. ✅ **配置正确性**
   - 2h系统：2.5MW + 1个减6簇 ✓
   - 4h系统：2.5MW + 2个减6簇 ✓
   - 6h系统：2.5MW + 2个不减簇 ✓

2. ✅ **功率匹配**
   - 各配置的功率校验都在合理范围内

3. ✅ **成本单价**
   - 复用7.5MW家族单价（0.46/0.41元/Wh）

4. ✅ **应用场景**
   - 小型项目优化明显
   - 成本节省真实可靠

5. ❓ **产品可行性**
   - **请确认**：2.5MW PCS是否为实际可提供的产品？
   - 如不可行，需调整方案

---

**文档版本**: 1.0  
**创建日期**: 2025年10月28日  
**状态**: 待审核  
**下一步**: 审核通过后修改代码并测试

