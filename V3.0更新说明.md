# 储能系统配置计算 V3.0 更新说明

## 版本信息
- **版本号**: V3.0
- **更新日期**: 2025年10月28日
- **主要变更**: 从等效成本模型升级为真实成本模型

## 核心变更

### 1. 成本计算模型升级

#### V2.x 版本（旧）
- 使用等效容量（MWh）作为成本指标
- 公式：`等效成本 = PCS等效容量 + 电池舱容量`
- 单位：MWh

#### V3.0 版本（新）
- 使用真实成本（万元）作为成本指标
- 公式：`真实成本 = 等效容量 × 100 × 单价`
- 单位：万元

### 2. 新增成本单价定义

| 系统类型 | 5MW家族单价 | 7.5MW家族单价 |
|---------|------------|--------------|
| 2h系统 | 0.51 元/Wh | 0.46 元/Wh |
| 4h系统 | 0.43 元/Wh | 0.41 元/Wh |
| 6h系统 | 0.43 元/Wh | 0.41 元/Wh |

**说明**: 
- 6h系统单价与4h系统相同
- 7.5MW家族单价普遍低于5MW家族

### 3. 系统支持范围调整

**支持的系统类型**: 2h, 4h, 6h

**不支持的系统类型**: 1h, 8h
- 当计算结果为1h或8h系统时，直接返回错误："暂不支持1或8小时系统"
- 不进行配置计算

### 4. 输出字段更新

#### 新增字段
- `total_cost`: 项目总成本（万元）
- `equivalent_capacity`: 总等效容量（MWh）
- `unit_price`: 应用的单价（元/Wh）

#### 保留字段
- `power`: 配置的总额定功率（MW）
- `capacity`: 配置的总直流容量（MWh）
- `system_hour_type`: 系统时长类型（2/4/6）
- `dc_family_technology`: 选用的电池舱家族
- 其他配置详情字段

### 5. 成本比较阈值动态化

#### 成本相似阈值
```
阈值（万元）= 0.1 MWh × 100 × 单价（元/Wh）
```

**示例**:
- 2h系统，5MW家族：0.1 × 100 × 0.51 = 5.1 万元
- 4h系统，7.5MW家族：0.1 × 100 × 0.41 = 4.1 万元

#### 内部成本平衡阈值
```
阈值（万元）= 0.01 MWh × 100 × 单价（元/Wh）
```

**示例**:
- 2h系统，5MW家族：0.01 × 100 × 0.51 = 0.51 万元
- 4h系统，7.5MW家族：0.01 × 100 × 0.41 = 0.41 万元

## 代码变更清单

### 1. 新增代码

#### `UNIT_PRICE_TABLE` (第27-40行)
```python
UNIT_PRICE_TABLE = {
    2: {"7.5MW": 0.46, "5MW": 0.51},
    4: {"7.5MW": 0.41, "5MW": 0.43},
    6: {"7.5MW": 0.41, "5MW": 0.43}
}
```

#### `get_unit_price()` 函数 (第48-61行)
获取指定系统类型和家族的单价

### 2. 修改的函数

#### `generate_single_ess_block_configs()`
- 字段名变更：`block_equivalent_cost_mwh` → `block_equivalent_capacity_mwh`

#### `find_best_combination_of_ess_blocks()`
- 新增参数：`system_hour_type`, `target_dc_family`
- 成本计算改为：`等效容量 × 100 × 单价`
- 动态计算成本阈值

#### `get_optimal_solution_for_dc_family()`
- 新增1h/8h系统检测和拒绝逻辑
- 添加单价和等效容量到输出
- 更新输出消息，显示真实成本

#### `get_overall_optimal_solution()`
- 处理1h/8h系统拒绝消息
- 返回新的输出字段

### 3. 精度调整

- 功率：保留3位小数（MW）
- 容量：保留3位小数（MWh）
- 等效容量：保留3位小数（MWh）
- **真实成本：保留2位小数（万元）**

## 测试验证

### 测试程序
- 文件：`test_all_sys.py`
- 包含8个测试用例

### 测试结果

✅ **通过的测试**:
1. 标准2h系统（50MW/100MWh）
   - 选用技术：7.5MW家族
   - 总成本：5189.08 万元
   
2. 标准4h系统（50MW/200MWh）
   - 选用技术：7.5MW家族
   - 总成本：8736.69 万元
   
3. 6h系统（10MW/60MWh）
   - 选用技术：7.5MW家族（使用5MW PCS）
   - 总成本：2570.04 万元
   
4. 小规模2h系统（10MW/20MWh）
   - 选用技术：7.5MW家族
   - 总成本：1037.76 万元
   
5. **1h系统拒绝测试**（100MW/100MWh）
   - ✅ 正确拒绝，消息："暂不支持1或8小时系统"
   
6. **8h系统拒绝测试**（10MW/100MWh）
   - ✅ 正确拒绝，消息："暂不支持1或8小时系统"
   
7. 零功率零容量（0MW/0MWh）
   - 正常处理，成本为0
   
8. **成本对比测试**（50MW/100MWh）
   - ✅ 正确选择7.5MW家族（单价更低）
   - V2.x会选择5MW（等效容量更小）
   - V3.0选择7.5MW（真实成本更低）

## 优势与改进

### V3.0的优势

1. **真实成本反映**: 直接以万元显示，更直观
2. **定价差异体现**: 7.5MW家族的单价优势得到体现
3. **决策更准确**: 基于实际采购成本而非抽象等效容量
4. **阈值更合理**: 成本阈值随系统类型和技术路线动态调整

### 典型场景对比

**场景**: 50MW / 100MWh (2h系统)

| 方案 | 等效容量 | V2.x结论 | V3.0单价 | V3.0成本 | V3.0结论 |
|------|---------|---------|---------|---------|---------|
| 5MW家族 | 112.5 MWh | ✅ 更优 | 0.51元/Wh | 5737.5万元 | 成本较高 |
| 7.5MW家族 | 118.4 MWh | 容量大 | 0.46元/Wh | 5448.6万元 | ✅ 更优 |

**结论**: V3.0能够正确识别7.5MW家族虽然等效容量大，但因单价低而成本更优。

## 使用示例

```python
from all_sys import get_overall_optimal_solution

# 调用方式不变
result = get_overall_optimal_solution(50, 100)

# 新的输出字段
print(f"总成本: {result['total_cost']:.2f} 万元")
print(f"等效容量: {result['equivalent_capacity']:.3f} MWh")
print(f"单价: {result['unit_price']:.2f} 元/Wh")
print(f"选用技术: {result['dc_family_technology']}")
```

## 兼容性说明

### 向后不兼容
- ⚠️ 输出字段名变更：建议使用 `total_cost` 而非 `cost`
- ⚠️ 成本单位变更：从 MWh 改为万元
- ⚠️ 方案选择可能改变：相同输入可能得到不同技术路线

### 保持兼容
- ✅ 函数调用接口不变
- ✅ 主要输出字段保留（power, capacity等）
- ✅ 配置详情结构不变

## 升级建议

1. **更新调用代码**: 使用 `total_cost`、`equivalent_capacity`、`unit_price` 新字段
2. **检查单位**: 所有成本相关计算改用万元
3. **验证结果**: 对关键项目重新计算验证
4. **文档更新**: 更新相关技术文档和用户手册

## 未来扩展

### 可能的增强
1. 增加1h和8h系统的单价定义
2. 支持用户自定义单价
3. 增加成本敏感性分析
4. 支持多种定价策略

---

**文档版本**: 1.0  
**创建日期**: 2025年10月28日  
**维护人员**: 系统开发组

